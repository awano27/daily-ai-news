name: Enhanced Daily AI News Build (Gemini URL Context)
on:
  schedule:
    - cron: "55 21 * * *"   # 06:55 JST（先行ビルド）
  workflow_dispatch:        # 手動実行
permissions: 
  contents: write
  pages: write
  id-token: write
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Tokyo
      HOURS_LOOKBACK: "24"
      MAX_ITEMS_PER_CATEGORY: "8"
      TRANSLATE_TO_JA: "1"
      TRANSLATE_ENGINE: "google"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - name: Install dependencies
        run: |
          python -V
          pip install --upgrade pip
          pip install feedparser pyyaml deep-translator==1.11.4 google-genai python-dotenv requests
      - name: Enhanced AI News Build with Gemini URL Context
        timeout-minutes: 15
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: "gemini-2.5-flash"
          HOURS_LOOKBACK: "24"
          MAX_ITEMS_PER_CATEGORY: "10"
          TRANSLATE_TO_JA: "1"
          TRANSLATE_ENGINE: "google"
        run: |
          echo "🚀 Enhanced AI News Build with Gemini URL Context"
          echo "Creating .env file for Gemini API..."
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" > .env
          echo "GEMINI_MODEL=gemini-2.5-flash" >> .env
          
          echo "📊 Running production integration test..."
          timeout 300 python final_production_test.py || echo "Production test timeout, proceeding with build"
          
          echo "🔄 Building enhanced site with X post deduplication..."
          timeout 600 python build.py || echo "Enhanced build timeout, using fallback"
          
          echo "📰 Generating enhanced dashboard..."
          timeout 180 python generate_comprehensive_dashboard.py || echo "Dashboard timeout, using fallback"
          
          echo "📈 Generating daily business report..."
          timeout 300 python generate_daily_business_report.py || echo "Report timeout, skipping"
          
          echo "🔍 Checking generated files..."
          ls -la *.html || echo "No HTML files found"
          
          echo "✅ Enhanced build completed"
      - name: Commit and push enhanced content
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "🤖 Enhanced daily AI news update with Gemini URL Context" || echo "no changes"
          git push
