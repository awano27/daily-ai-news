name: Deploy to Public Pages Repo

on:
  # 一本化のため自動実行を停止。臨時時のみ手動実行
  workflow_dispatch:

jobs:
  deploy-to-public:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    # Daily buildが成功した場合のみ実行（手動実行は常に実行）
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git config
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Create outputs directory
        run: |
          mkdir -p outputs
          
      - name: Copy built files to outputs
        run: |
          # Enhanced system で生成されるHTMLファイルをコピー
          cp -f index.html outputs/ 2>/dev/null || true
          cp -f news_detail.html outputs/ 2>/dev/null || true
          cp -f ai_news_dashboard.html outputs/ 2>/dev/null || true
          cp -f dashboard.html outputs/ 2>/dev/null || true
          
          # news_detail.html を index.html としてもコピー（メインページとして）
          if [ -f "news_detail.html" ] && [ ! -f "outputs/index.html" ]; then
            echo "index.html not found in outputs – using news_detail.html fallback"
            cp news_detail.html outputs/index.html
          fi
          
          # 必要な静的ファイルをコピー（あれば）
          [ -d "assets" ] && cp -r assets outputs/ || true
          [ -d "css" ] && cp -r css outputs/ || true
          [ -d "js" ] && cp -r js outputs/ || true
          [ -f ".nojekyll" ] && cp .nojekyll outputs/ || true
          
          # チェック: outputsディレクトリの中身を確認
          echo "📁 Contents of outputs directory:"
          ls -la outputs/

      - name: Check if index.html exists
        run: |
          if [ ! -f "outputs/index.html" ]; then
            echo "⚠️ Warning: index.html not found in outputs directory"
            echo "Creating placeholder index.html..."
            echo '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>AI News Dashboard</title></head><body><h1>AI News Dashboard - Building...</h1><p>The dashboard is currently being generated. Please check back later.</p></body></html>' > outputs/index.html
          fi

      - name: Check token presence
        run: |
          echo HAS_TOKEN=${{ secrets.PERSONAL_TOKEN != '' }}

      - name: Deploy to public repository
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.PERSONAL_TOKEN }}
          github_token: ${{ secrets.PERSONAL_TOKEN }}
          external_repository: awano27/daily-ai-news-pages
          publish_branch: gh-pages
          publish_dir: ./outputs
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy from private repo: ${{ github.sha }}'
          force_orphan: false
          keep_files: false
          enable_jekyll: false

      - name: Verify deployment
        run: |
          echo "✅ Deployment completed!"
          echo "📍 Public site will be available at: https://awano27.github.io/daily-ai-news-pages/"
          echo "🔗 Public repository: https://github.com/awano27/daily-ai-news-pages"